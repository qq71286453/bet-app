<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>歡喜大發財計算機</title>

<style>
*{ box-sizing:border-box; }
body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
    background:linear-gradient(135deg,#1e3c72,#2a5298);
    margin:0;
    padding:30px 15px;
}
.container{
    max-width:1100px;
    margin:auto;
    display:flex;
    gap:25px;
    flex-wrap:wrap;
    justify-content:center;
}
.card{
    background:white;
    border-radius:18px;
    padding:25px;
    box-shadow:0 15px 35px rgba(0,0,0,0.15);
}
.box{ width:420px; }
.history{ width:450px; max-height:650px; overflow:auto; }
.row{ margin-top:14px; }
label{
    font-size:14px;
    font-weight:600;
    margin-bottom:5px;
    display:block;
}
input{
    width:100%;
    padding:10px;
    font-size:16px;
    border-radius:10px;
    border:1px solid #ddd;
}
input[readonly]{ background:#f7f7f7; }

button{
    border:none;
    border-radius:12px;
    padding:12px;
    font-size:16px;
    font-weight:bold;
    cursor:pointer;
}
.btn-row{
    display:flex;
    gap:10px;
    margin-top:15px;
}
.btn-win{ background:#28a745; color:white; flex:1; }
.btn-lose{ background:#dc3545; color:white; flex:1; }
.reset-btn{
    margin-top:12px;
    width:100%;
    background:#f1f1f1;
}

.green{ background:#e6f7ed; }
.yellow{ background:#fff8e1; }
.red{ background:#fdecea; }

.rate-green{ color:#28a745; font-weight:bold; }
.rate-red{ color:#dc3545; font-weight:bold; }

.profit-green{ color:#28a745; font-weight:bold; }
.profit-red{ color:#dc3545; font-weight:bold; }
.profit-zero{ color:#000; font-weight:bold; }

.stat-box{
    background:#f5f7fa;
    padding:12px;
    border-radius:12px;
    font-weight:bold;
    font-size:14px;
    margin-bottom:15px;
    line-height:1.6;
}

.record-item{
    padding:8px 10px;
    border-bottom:1px solid #eee;
    font-size:14px;
}
.win-text{ color:#28a745; }
.lose-text{ color:#dc3545; }

@media(max-width:768px){
    .box,.history{ width:100%; }
}
</style>
</head>

<body>

<div class="container">

<div class="card box">
<h2>歡喜大發財計算機</h2>

<div class="row"><label>歷史高峰</label><input type="number" id="high"></div>
<div class="row"><label>3/4 警戒線</label><input type="number" id="line34" readonly></div>
<div class="row"><label>2/3 警戒線</label><input type="number" id="line23" readonly></div>
<div class="row"><label>剩餘彩幣</label><input type="number" id="remain"></div>
<div class="row"><label>一注金額</label><input type="number" id="bet"></div>
<div class="row"><label>賠率</label><input type="number" id="odds" step="0.01"></div>

<div class="btn-row">
<button class="btn-win" onclick="settle(true,'normal')">勝</button>
<button class="btn-lose" onclick="settle(false,'normal')">敗</button>
</div>

<div class="btn-row">
<button class="btn-win" onclick="settle(true,'half')">加勝</button>
<button class="btn-lose" onclick="settle(false,'half')">加敗</button>
</div>

<div class="btn-row">
<button class="btn-win" onclick="settle(true,'cat')">貓勝</button>
<button class="btn-lose" onclick="settle(false,'cat')">貓敗</button>
</div>

<button class="reset-btn" onclick="undoLast()">返回上一步</button>
<button class="reset-btn" onclick="resetAll()">一鍵重置</button>
</div>

<div class="card history">
<h3>統計資訊</h3>
<div class="stat-box" id="stats"></div>
<h3>勝敗紀錄</h3>
<div id="record"></div>
</div>

</div>

<script>

let manualMode=false;
let totalProfit=0;

let winCount=0;
let loseCount=0;
let halfWinCount=0;
let halfLoseCount=0;
let catWinCount=0;
let catLoseCount=0;

let historyData=[];

const highInput=document.getElementById("high");
const remainInput=document.getElementById("remain");
const betInput=document.getElementById("bet");
const oddsInput=document.getElementById("odds");
const recordDiv=document.getElementById("record");
const statsDiv=document.getElementById("stats");

highInput.addEventListener("input",update);
remainInput.addEventListener("input",()=>{manualMode=false;update();});
betInput.addEventListener("input",()=>{manualMode=true;});

function update(){
    let high=Number(highInput.value);
    let remain=Number(remainInput.value);
    if(high<=0) return;

    let line34=Math.round(high*0.75);
    let line23=Math.round(high*2/3);

    document.getElementById("line34").value=line34;
    document.getElementById("line23").value=line23;

    remainInput.classList.remove("green","yellow","red");

    let autoBet=0;

    if(remain>=line34){
        remainInput.classList.add("green");
        autoBet=remain*0.04;
    }else if(remain>=line23){
        remainInput.classList.add("yellow");
        autoBet=remain*0.03;
    }else{
        remainInput.classList.add("red");
        autoBet=remain*0.02;
    }

    if(!manualMode){
        betInput.value=Math.round(autoBet);
    }

    saveData();
}

function settle(isWin,type){

    let remain=Number(remainInput.value);
    let high=Number(highInput.value);
    let bet=Number(betInput.value);
    let odds=Number(oddsInput.value);

    let profit=isWin?bet*(odds-1):-bet;
    profit=Math.round(profit);

    let prevRemain=remain;
    let prevHigh=high;

    remain=Math.round(remain+profit);

    if(remain>high){
        high=remain;
        highInput.value=high;
    }

    totalProfit+=profit;

    if(type==="half"){
        if(isWin) halfWinCount++;
        else halfLoseCount++;
    }else if(type==="cat"){
        if(isWin) catWinCount++;
        else catLoseCount++;
    }else{
        if(isWin) winCount++;
        else loseCount++;
    }

    historyData.unshift({
        type,isWin,bet,odds,profit,
        prevRemain,prevHigh,remain
    });

    remainInput.value=remain;

    render();
    manualMode=false;
    update();
}

function undoLast(){
    if(historyData.length===0){ alert("沒有可返回的紀錄"); return; }

    let last=historyData.shift();
    totalProfit-=last.profit;

    if(last.type==="half"){
        if(last.isWin) halfWinCount--;
        else halfLoseCount--;
    }else if(last.type==="cat"){
        if(last.isWin) catWinCount--;
        else catLoseCount--;
    }else{
        if(last.isWin) winCount--;
        else loseCount--;
    }

    remainInput.value=last.prevRemain;
    highInput.value=last.prevHigh;

    render();
    update();
}

function rateClass(rate){
    return rate>=60 ? "rate-green" : "rate-red";
}

function render(){

    recordDiv.innerHTML="";

    historyData.forEach(r=>{
        let div=document.createElement("div");
        div.className="record-item "+(r.isWin?"win-text":"lose-text");

        let typeLabel="";
        if(r.type==="half") typeLabel="加";
        if(r.type==="cat") typeLabel="貓";

        let oddsFixed = Number(r.odds).toFixed(2);

        div.textContent =
            typeLabel +
            (r.isWin ? "勝" : "敗") +
            "|注碼:" + r.bet +
            "|賠率:" + oddsFixed +
            "|結果:" + (r.profit >= 0 ? "+" : "") + r.profit +
            "|剩餘:" + r.remain;

        recordDiv.appendChild(div);
    });

    let totalWins = winCount + halfWinCount + catWinCount;
    let totalLoses = loseCount + halfLoseCount + catLoseCount;
    let totalGames = totalWins + totalLoses;
    let totalRate = totalGames>0?((totalWins/totalGames)*100).toFixed(1):0;

    let halfTotal = halfWinCount + halfLoseCount;
    let halfRate = halfTotal>0?((halfWinCount/halfTotal)*100).toFixed(1):0;

    let catTotal = catWinCount + catLoseCount;
    let catRate = catTotal>0?((catWinCount/catTotal)*100).toFixed(1):0;

    let profitClass="profit-zero";
    if(totalProfit>0) profitClass="profit-green";
    if(totalProfit<0) profitClass="profit-red";

    statsDiv.innerHTML=
        "總場次："+totalGames+
        " ｜ 總勝："+totalWins+
        " ｜ 總敗："+totalLoses+
        " ｜ 總勝率：<span class='"+rateClass(Number(totalRate))+"'>"+totalRate+"%</span><br>"+
        "加場次："+halfTotal+
        " ｜ 加勝："+halfWinCount+
        " ｜ 加敗："+halfLoseCount+
        " ｜ 加勝率：<span class='"+rateClass(Number(halfRate))+"'>"+halfRate+"%</span><br>"+
        "貓場次："+catTotal+
        " ｜ 貓勝："+catWinCount+
        " ｜ 貓敗："+catLoseCount+
        " ｜ 貓勝率：<span class='"+rateClass(Number(catRate))+"'>"+catRate+"%</span><br>"+
        "總損益：<span class='"+profitClass+"'>"+totalProfit+"</span>";

    saveData();
}

function saveData(){
    localStorage.setItem("betSystem",JSON.stringify({
        high:highInput.value,
        remain:remainInput.value,
        bet:betInput.value,
        odds:oddsInput.value,
        totalProfit,
        winCount,loseCount,
        halfWinCount,halfLoseCount,
        catWinCount,catLoseCount,
        historyData
    }));
}

function loadData(){
    let data=localStorage.getItem("betSystem");
    if(!data) return;
    let obj=JSON.parse(data);

    highInput.value=obj.high;
    remainInput.value=obj.remain;
    betInput.value=obj.bet;
    oddsInput.value=obj.odds;

    totalProfit=obj.totalProfit||0;
    winCount=obj.winCount||0;
    loseCount=obj.loseCount||0;
    halfWinCount=obj.halfWinCount||0;
    halfLoseCount=obj.halfLoseCount||0;
    catWinCount=obj.catWinCount||0;
    catLoseCount=obj.catLoseCount||0;
    historyData=obj.historyData||[];

    render();
    update();
}

function resetAll(){
    if(!confirm("確定要重置所有資料？")) return;
    localStorage.removeItem("betSystem");
    location.reload();
}

loadData();

</script>
</body>
</html>
